# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
  merge:
    branches:
      - main
jobs:
  # First job to build the resume and push it to the repository
  build_resume:
    # Only run this job if the commit message contains [resume]
    if: "contains(github.event.head_commit.message, '[resume]')"
    runs-on: ubuntu-latest
    steps:
      # Step to checkout the repository
      - name: Checkout Repo for Resume
        uses: actions/checkout@v3

      # Step to compile the LaTeX resume
      - name: Compile Resume LaTeX to PDF
        uses: xu-cheng/latex-action@v2
        with:
          # The root LaTeX file to be compiled
          root_file: resume_main.tex
          # The working directory for this action
          working_directory: resume_builder
          # Extra arguments to be passed to the LaTeX engine
          args: -pdf -file-line-error -halt-on-error -interaction=nonstopmode
          # Arbitrary bash codes to be executed before compiling LaTeX documents
          pre_compile: tlmgr update --self && tlmgr update --all
          # Arbitrary bash codes to be executed after compiling LaTeX documents
          post_compile: latexmk -c
          latexmk_use_xelatex: true

      # Step to verify the PDF file exists and move it to the public folder
      - name: Move Resume.pdf file
        run: |
          mv resume_main.pdf ../public/resume.pdf

      # Step to push the PDF file to the repository
      - name: Upload Resume.pdf file to repository
        run: |
          git config --global user.name "lulrai"
          git config --global user.email "neupanenischal1@gmail.com"
          git add ../public/resume.pdf
          git commit -m "Updated resume"
          git push

  # Second job to build the project and deploy it to Firebase Hosting
  build_and_deploy:
    # Only run this job if the commit message does not contain [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    # Build the resume first if it needs to be built
    needs: build_resume
    runs-on: ubuntu-latest
    steps:
      # Step to checkout the repository
      - name: Checkout Repo
        uses: actions/checkout@v3

      # Step to install Node.js and Yarn
      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'

      # Step to install dependencies and build the project
      - name: GitHub Action for Yarn
        uses: Borales/actions-yarn@v4.2.0
        with:
          cmd: install
      - name: Build production bundle
        uses: borales/actions-yarn@v4
        with:
          cmd: build
        env:
          VITE_GH_API_KEY: ${{ secrets.VITE_GH_API_KEY }}

      # Step to deploy to Firebase Hosting
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTFOLIO_25124 }}'
          projectId: portfolio-25124
          channelId: live
